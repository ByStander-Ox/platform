version: 2 # use CircleCI 2.0
jobs: # a collection of steps
  build: # runs not using Workflows must have a `build` job as entry point
    docker: # run the steps with Docker
      - image: circleci/openjdk:8-jdk-stretch-node  
    steps: # a collection of executable commands
      - checkout # check out source code to working directory
      - restore_cache: # restore the saved cache after the first run or if `pom.xml` has changed
          key: platform-{{ checksum "versions.json" }}
      - run: scripts/generateBoms.sh
      - run: scripts/validateVersions.js
      - run: mvn install -Dvaadin.bowerMode=false -Pnpm-it,!bower-it -DskipTests
      - run: scripts/checkForNonPinnedDependencies.sh
      - run: mvn package -Dvaadin.bowerMode=false  -Pjavadocs -DskipTests
      - run: npm install bower
      - run: cd scripts/generator && npm test && cd ../../
      - run: mvn clean verify -Dvaadin.bowerMode=false  -B -Pproduction
      - run: scripts/verifyBowerDependencies.sh
      - run: scripts/verifyNpmDependencies.sh
      - run: scripts/npmShrinkwrap.sh      
      - save_cache: # saves the project dependencies
          paths:
            - ~/.m2
            - ~/.npm 
          key: circleci-demo-java-spring-{{ checksum "versions.xml" }}
      
